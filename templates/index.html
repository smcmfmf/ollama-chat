<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>ollama_chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  
  <style>
    :root { 
      color-scheme: dark;
      --sidebar-width: 260px;
      
      --bg-primary: #131314;
      --bg-secondary: #1e1f20;
      --border-color: #3c4043;
      --text-primary: #e3e3e3;
      --text-secondary: #9b9b9b;
      --user-bg: #3c4043;
      --assistant-bg: #1e1f20;
      --hover-bg: #3c4043;
      --accent-blue: #89b4f8;
    }
    
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'Noto Sans KR', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto;
      background: var(--bg-primary);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
      position: relative;
    }
    
    .aurora-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      overflow: hidden;
      background: #0a0a0a;
    }
    
    .aurora-bg::before,
    .aurora-bg::after {
      content: '';
      position: absolute;
      width: 200%;
      height: 200%;
      top: -50%;
      left: -50%;
      background: 
        radial-gradient(ellipse at 20% 30%, rgba(16, 185, 129, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 70%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
      animation: aurora 20s ease-in-out infinite;
    }
    
    .aurora-bg::after {
      animation-delay: -10s;
      animation-duration: 25s;
      background: 
        radial-gradient(ellipse at 60% 20%, rgba(236, 72, 153, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 30% 80%, rgba(59, 130, 246, 0.12) 0%, transparent 50%),
        radial-gradient(ellipse at 70% 60%, rgba(16, 185, 129, 0.08) 0%, transparent 50%);
    }
    
    @keyframes aurora {
      0%, 100% {
        transform: translate(0, 0) rotate(0deg) scale(1);
        opacity: 1;
      }
      25% {
        transform: translate(-5%, 5%) rotate(5deg) scale(1.1);
        opacity: 0.8;
      }
      50% {
        transform: translate(5%, -5%) rotate(-3deg) scale(1.05);
        opacity: 0.9;
      }
      75% {
        transform: translate(-3%, -8%) rotate(2deg) scale(1.08);
        opacity: 0.85;
      }
    }

    #fireflies {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      z-index: 0;
      pointer-events: none;
      display: block;
    }
    
    #app {
      display: flex;
      height: 100vh;
      position: relative;
      z-index: 1;
    }
    
    #sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(to bottom, 
        rgba(16, 185, 129, 0.08) 0%,
        rgba(59, 130, 246, 0.08) 50%,
        rgba(139, 92, 246, 0.08) 100%
      ), rgba(30, 31, 32, 0.7);
      backdrop-filter: blur(20px);
      border-right: 1px solid rgba(60, 64, 67, 0.3);
      display: flex;
      flex-direction: column;
      transition: margin-left 0.3s ease;
      box-shadow: 0 0 40px rgba(59, 130, 246, 0.1);
      margin-left: calc(-1 * var(--sidebar-width));
    }
    #sidebar.visible { margin-left: 0; }
    #sidebar.hidden { margin-left: calc(-1 * var(--sidebar-width)); }
    #sidebar.visible { margin-left: 0; }
    .sidebar-header { padding: 16px; border-bottom: 1px solid rgba(60, 64, 67, 0.3); }
    .new-chat-btn { width: 100%; padding: 12px 16px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; color: var(--text-primary); cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .new-chat-btn:hover { background: rgba(59, 130, 246, 0.2); border-color: rgba(59, 130, 246, 0.5); }
    .chat-list { flex: 1; overflow-y: auto; padding: 8px; }
    .chat-item { padding: 12px; margin: 4px 0; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.2s; display: flex; justify-content: space-between; align-items: center; border: 1px solid transparent; }
    .chat-item:hover { background: rgba(59, 130, 246, 0.15); }
    .chat-item.active { background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); }
    .chat-item-title { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .delete-chat { opacity: 0; padding: 4px 8px; border: none; background: none; color: var(--text-secondary); cursor: pointer; font-size: 12px; }
    .chat-item:hover .delete-chat { opacity: 1; }
    
    #main { flex: 1; display: flex; flex-direction: column; position: relative; }
    #toggleSidebar { position: absolute; top: 16px; left: 16px; padding: 8px 12px; background: rgba(30, 31, 32, 0.85); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-radius: 8px; cursor: pointer; font-size: 14px; z-index: 10; transition: all 0.2s; }
    #toggleSidebar:hover { background: var(--hover-bg); }
    #chatContainer { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
    .empty-state { flex: 1; display: flex; align-items: flex-end; justify-content: center; padding: 40px 20px 0; }
    .empty-content { max-width: 800px; width: 100%; text-align: center; margin: 0 auto; }
    .empty-title { font-size: 48px; font-weight: 700; margin-bottom: 12px; color: var(--accent-blue); }
    .empty-subtitle { font-size: 22px; color: var(--text-secondary); margin-top: -10px; }
    .messages { flex: 1; padding: 80px 20px 20px; max-width: 800px; width: 100%; margin: 0 auto; }
    .message { display: flex; margin: 24px 0; gap: 16px; }
    .message.user { justify-content: flex-end; }
    .message.assistant { justify-content: flex-start; }
    .message-content { max-width: 80%; white-space: pre-wrap; word-wrap: break-word; padding: 12px 16px; border-radius: 12px; }
    .message.user .message-content { background: rgba(60, 64, 67, 0.8); backdrop-filter: blur(10px); border: 1px solid var(--border-color); border-bottom-right-radius: 4px; color: var(--text-primary); }
    .message.assistant .message-content { background: rgba(30, 31, 32, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--accent-blue); border-bottom-left-radius: 4px; font-size: 16px; line-height: 1.7; }

    .input-container {
      padding: 20px;
      border-top: none;
      background: transparent;
    }
    
    .input-wrapper {
      max-width: 800px;
      margin: 0 auto;
      position: relative;
    }
    
    .input-box {
      display: flex;
      align-items: flex-end;
      gap: 12px;
      
      background: rgba(30, 31, 32, 0.8);
      backdrop-filter: blur(10px);
      border: 1px solid var(--border-color);
      border-radius: 28px;
      padding: 10px 12px 10px 20px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.1);
      
      transition: all 0.3s ease;
    }
    
    .input-box:focus-within {
      border-color: var(--accent-blue);
      box-shadow: 0 0 8px 0 var(--accent-blue);
    }

    textarea {
      flex: 1;
      border: none;
      background: transparent;
      color: var(--text-primary);
      resize: none;
      font-size: 16px;
      line-height: 1.6;
      max-height: 200px;
      outline: none;
      font-family: inherit;
      padding-bottom: 5px;
    }
    
    .send-btn {
      padding: 0;
      background: var(--accent-blue);
      color: var(--bg-primary);
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      font-weight: 500;
      transition: opacity 0.2s;
      width: 38px;
      height: 38px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }
    
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .send-btn:not(:disabled):hover { opacity: 0.8; }
    
    .model-select {
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-secondary);
      text-align: center;
    }
    
    .model-select input {
      background: rgba(19, 19, 20, 0.8);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    
    #main.is-empty { justify-content: center; }
    #main.is-empty #chatContainer { flex: 0 1 auto; }
    #main.is-empty .input-container { border-top: none; background: transparent; padding-top: 40px; padding-bottom: 20px; }
    
    #main.is-empty .input-box {
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    #main.is-empty .input-box:focus-within {
      border-color: var(--accent-blue);
      box-shadow: 0 0 8px 0 var(--accent-blue);
    }
    
    .spinner { display: inline-block; width: 12px; height: 12px; border: 2px solid currentColor; border-right-color: transparent; border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
  </style>
</head>
<body>
  <div class="aurora-bg">
    <canvas id="fireflies"></canvas>
  </div>
  
  <div id="app">
    <div id="sidebar">
      <div class="sidebar-header">
        <button class="new-chat-btn" id="newChatBtn">+ 새 채팅</button>
      </div>
      <div class="chat-list" id="chatList"></div>
    </div>
    
    <div id="main">
      <button id="toggleSidebar">☰</button>
      
      <div id="chatContainer">
        </div>
      
      <div class="input-container">
        <div class="input-wrapper">
          
          <div class="input-box">
            <textarea 
              id="prompt" 
              placeholder="메시지를 입력하세요..."
              rows="1"
            ></textarea>
            <button class="send-btn" id="sendBtn">→</button>
          </div>
          
          <div class="model-select">
            <label>모델: <input id="model" value="gemma3:4b" /></label>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const canvas = document.getElementById('fireflies');
      const ctx = canvas.getContext('2d');

      const cfg = {
        maxParticles: 90,
        spawnChancePerFrame: 0.06,
        colors: ['rgba(255,240,200,0.9)','rgba(200,240,255,0.9)','rgba(200,255,220,0.9)','rgba(255,210,240,0.9)'],
        sizeRange: [0.6, 2.6],
        lifeRange: [2.5, 6.5],
        driftX: 10,
        driftY: 8,
        twinkleSpeed: 0.02,
      };

      let particles = [];
      let lastTime = performance.now();

      function resize(){
        const dpr = Math.max(1, window.devicePixelRatio || 1);
        canvas.width = Math.ceil(canvas.clientWidth * dpr);
        canvas.height = Math.ceil(canvas.clientHeight * dpr);
        ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      }
      window.addEventListener('resize', resize);
      canvas.style.width = '100%';
      canvas.style.height = '100%';
      resize();

      function rand(min, max){ return Math.random() * (max - min) + min; }

      class Particle {
        constructor(){
          this.reset(true);
        }
        reset(initial){
          this.x = rand(0, canvas.clientWidth);
          this.y = rand(canvas.clientHeight * 0.2, canvas.clientHeight * 0.95);
          const speed = rand(5, 20);
          const angle = rand(-Math.PI/4, Math.PI/4);
          this.vx = Math.cos(angle) * (speed/100) * cfg.driftX;
          this.vy = -Math.abs(Math.sin(angle)) * (speed/100) * cfg.driftY * rand(0.2,1.2);
          this.size = rand(cfg.sizeRange[0], cfg.sizeRange[1]);
          this.baseAlpha = rand(0.35, 0.95);
          this.alpha = initial ? 0 : this.baseAlpha;
          this.color = cfg.colors[Math.floor(rand(0, cfg.colors.length))];
          this.life = rand(cfg.lifeRange[0], cfg.lifeRange[1]);
          this.age = initial ? rand(0, this.life) : 0;
          this.twinkle = rand(0, Math.PI*2);
          this.removed = false;
        }
        update(dt){
          this.age += dt;
          if (this.age >= this.life){
            if (particles.length > cfg.maxParticles * 0.6 && Math.random() < 0.6) {
              this.removed = true;
              return;
            }
            this.reset(false);
            return;
          }
          this.x += this.vx * dt * 60;
          this.y += this.vy * dt * 60 + Math.sin(this.age * 2 + this.twinkle) * 0.15;

          const t = this.age / this.life;
          if (t < 0.12) this.alpha = this.baseAlpha * (t/0.12);
          else if (t > 0.88) this.alpha = this.baseAlpha * ((1 - t)/0.12);
          else this.alpha = this.baseAlpha * (0.8 + 0.2 * Math.sin((this.age + this.twinkle) * 6 * cfg.twinkleSpeed));
        }
        draw(ctx){
          ctx.save();
          ctx.globalCompositeOperation = 'lighter';
          ctx.shadowBlur = Math.max(8, this.size * 12);
          ctx.shadowColor = this.color;
          ctx.fillStyle = this.color.replace(/,[^,]+\)$/,' , ' + this.alpha + ')');
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size*2.2, 0, Math.PI*2);
          ctx.fill();
          ctx.shadowBlur = 0;
          ctx.globalCompositeOperation = 'source-over';
          ctx.fillStyle = this.color.replace(/,[^,]+\)$/,' , ' + Math.min(1,this.alpha+0.35) + ')');
          ctx.beginPath();
          ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
          ctx.fill();
          ctx.restore();
        }
      }

      function spawnOne(){
        if (particles.length >= cfg.maxParticles) return;
        particles.push(new Particle());
      }

      function step(now){
        const dt = Math.min(0.06, (now - lastTime) / 1000);
        lastTime = now;

        if (Math.random() < cfg.spawnChancePerFrame) spawnOne();

        if (Math.random() < 0.002 && particles.length < cfg.maxParticles - 6) {
          for (let i=0;i<3;i++) spawnOne();
        }

        ctx.clearRect(0,0,canvas.clientWidth, canvas.clientHeight);

        for (let i = particles.length - 1; i >= 0; i--) {
          const p = particles[i];
          p.update(dt);
          if (p.removed) particles.splice(i,1);
          else p.draw(ctx);
        }

        requestAnimationFrame(step);
      }

      for (let i=0;i<12;i++) spawnOne();
      requestAnimationFrame(step);

      let resizeTimeout;
      function handleResize(){
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(()=>{
          resize();
        }, 80);
      }
      window.addEventListener('resize', handleResize);

      window.addEventListener('pointerdown', (e) => {
        for (let i=0;i<4;i++){
          if (particles.length < cfg.maxParticles) {
            const p = new Particle();
            p.x = e.clientX;
            p.y = e.clientY;
            p.vx = rand(-8,8) / 40;
            p.vy = rand(-20,-6) / 40;
            particles.push(p);
          }
        }
      });

    })();
  </script>

  <script>
    const $ = (id) => document.getElementById(id);
    const sidebar = $("sidebar");
    const chatContainer = $("chatContainer");
    const chatList = $("chatList");
    const promptTA = $("prompt");
    const sendBtn = $("sendBtn");
    const modelInput = $("model");
    const toggleBtn = $("toggleSidebar");
    const newChatBtn = $("newChatBtn");
    const mainEl = $("main");
    let chats = [];
    let currentChatId = null;
    init();
    function init() {
      createNewChat();
      renderChatList();
      renderChatView();
      toggleBtn.addEventListener("click", () => {
        sidebar.classList.toggle("visible");
      });
      newChatBtn.addEventListener("click", createNewChat);
      sendBtn.addEventListener("click", sendMessage);
      promptTA.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
      promptTA.addEventListener("input", autoResize);
    }
    function autoResize() {
      promptTA.style.height = "auto";
      promptTA.style.height = promptTA.scrollHeight + "px";
    }
    function createNewChat() {
      const newChat = { id: Date.now(), title: "새 채팅", history: [] };
      chats.unshift(newChat);
      currentChatId = newChat.id;
      renderChatList();
      renderChatView();
    }
    function selectChat(id) {
      currentChatId = id;
      renderChatList();
      renderChatView();
    }
    function deleteChat(id, event) {
      event.stopPropagation();
      chats = chats.filter(c => c.id !== id);
      if (currentChatId === id) {
        currentChatId = chats.length > 0 ? chats[0].id : null;
        if (currentChatId === null) {
          createNewChat();
          return;
        }
      }
      renderChatList();
      renderChatView();
    }
    function renderChatList() {
      chatList.innerHTML = chats.map(chat => `
        <div class="chat-item ${chat.id === currentChatId ? 'active' : ''}" 
             onclick="selectChat(${chat.id})">
          <span class="chat-item-title">${chat.title}</span>
          <button class="delete-chat" onclick="deleteChat(${chat.id}, event)">×</button>
        </div>
      `).join('');
    }
    function renderChatView() {
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      if (chat.history.length === 0) {
        mainEl.classList.add("is-empty");
        chatContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-content">
              <h1 class="empty-title">안녕하세요.</h1>
              <p class="empty-subtitle">무엇을 도와드릴까요?</p>
            </div>
          </div>
        `;
      } else {
        mainEl.classList.remove("is-empty");
        chatContainer.innerHTML = `
          <div class="messages" id="messages">
            ${chat.history.map(msg => `
              <div class="message ${msg.role}" ${msg.attachId ? `data-attach-id="${msg.attachId}"` : ''}>
                <div class="message-content">${msg.content || ''}</div>
              </div>
            `).join('')}
          </div>
        `;
        const messagesDiv = chatContainer.querySelector("#messages");
        if (messagesDiv) {
          chatContainer.scrollTop = chatContainer.scrollHeight;
        }
      }
    }
    function updateMessageContent(attachId, appendText) {
      const messageDiv = chatContainer.querySelector(`[data-attach-id="${attachId}"] .message-content`);
      if (messageDiv) {
        messageDiv.textContent += appendText;
        chatContainer.scrollTop = chatContainer.scrollHeight;
      }
    }
    async function sendMessage() {
      const content = promptTA.value.trim();
      if (!content) return;
      const chat = chats.find(c => c.id === currentChatId);
      if (!chat) return;
      promptTA.value = "";
      promptTA.style.height = "auto";
      if (chat.history.length === 0) {
        chat.title = content.slice(0, 30) + (content.length > 30 ? "..." : "");
        renderChatList();
      }
      chat.history.push({ role: "user", content });
      renderChatView();
      const attachId = String(Date.now());
      chat.history.push({ role: "assistant", content: "", attachId });
      renderChatView();
      sendBtn.disabled = true;
      sendBtn.innerHTML = '<span class="spinner"></span>';
      try {
        const resp = await fetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            model: modelInput.value || "gemma3:4b",
            messages: chat.history.filter(m => !m.attachId).map(m => ({
              role: m.role,
              content: m.content
            })),
          }),
        });
        if (!resp.ok) {
           throw new Error(`HTTP error! status: ${resp.status}`);
        }
        const reader = resp.body.getReader();
        const decoder = new TextDecoder();
        let assistantAccum = "";
        while (true) {
          const { value, done } = await reader.read();
          if (done) break;
          const chunk = decoder.decode(value, { stream: true });
          for (const line of chunk.split("\n")) {
            const trimmed = line.trim();
            if (!trimmed) continue;
            try {
              const obj = JSON.parse(trimmed);
              if (obj.message && typeof obj.message.content === "string") {
                assistantAccum += obj.message.content;
                updateMessageContent(attachId, obj.message.content);
              }
              if (obj.done) {
                const assistantMsg = chat.history.find(m => m.attachId === attachId);
                if (assistantMsg) {
                  assistantMsg.content = assistantAccum;
                  delete assistantMsg.attachId;
                }
              }
            } catch (e) {
            }
          }
        }
      } catch (e) {
        updateMessageContent(attachId, "\n[에러] 응답을 가져오는 중 문제가 발생했습니다.");
        console.error(e);
      } finally {
        sendBtn.disabled = false;
        sendBtn.innerHTML = "→";
      }
    }
    window.selectChat = selectChat;
    window.deleteChat = deleteChat;
  </script>
</body>
</html>
